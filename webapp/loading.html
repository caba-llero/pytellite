<!DOCTYPE html>
<html>
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XNKBLJZQLQ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);} 
        gtag('js', new Date());
        gtag('config', 'G-XNKBLJZQLQ');
    </script>
    <title>Pytellite - loading</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <style>
        body { background: #0b0b0b; overflow: hidden; }
        .loading-wrap { display: flex; align-items: center; justify-content: center; height: 100vh; width: 100vw; }
        .loading-card { text-align: center; color: #e6eefc; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
        .loading-title { font-size: 22px; margin-top: 12px; color: #ffffff; }
        .bar { width: 300px; height: 10px; background: #1f242b; border-radius: 999px; overflow: hidden; margin-top: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
        .bar-inner { height: 100%; width: 0%; background: linear-gradient(135deg, #006896, #0091c7); transition: width 0.2s ease; }
        .logo { display: block; height: 75px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="loading-wrap">
        <div class="loading-card">
            <img src="/logo.png" alt="Logo" class="logo">
            <div class="loading-title">Loading...</div>
            <div class="bar"><div class="bar-inner" id="bar"></div></div>
        </div>
    </div>
    <script>
        (async function() {
            const params = new URLSearchParams(window.location.search);
            const bar = document.getElementById('bar');

            function animateTo(percent) { bar.style.width = percent + '%'; }
            animateTo(10);

            // Build compute payload from URL params
            function readFloat(k) { const v = params.get(k); return v !== null ? parseFloat(v) : null; }
            const payload = {};
            const inertia = [readFloat('j1'), readFloat('j2'), readFloat('j3')];
            const shape = [readFloat('sx'), readFloat('sy'), readFloat('sz')];
            const q_bi = [readFloat('qx'), readFloat('qy'), readFloat('qz'), readFloat('qw')];
            const omega = [readFloat('wx'), readFloat('wy'), readFloat('wz')];
            if (inertia.every(v => typeof v === 'number' && !isNaN(v))) payload.inertia = inertia;
            if (shape.every(v => typeof v === 'number' && !isNaN(v))) payload.shape = shape;
            if (q_bi.every(v => typeof v === 'number' && !isNaN(v))) payload.q_bi = q_bi;
            if (omega.every(v => typeof v === 'number' && !isNaN(v))) payload.omega_bi_radps = omega;
            const tmax = readFloat('tmax'); if (tmax !== null) payload.t_max = tmax;
            const play = readFloat('play'); if (play !== null) payload.playback_speed = play;
            const sr = readFloat('sr'); if (sr !== null) payload.sample_rate = sr;
            const rtol = readFloat('rtol'); if (rtol !== null) payload.rtol = rtol;
            const atol = readFloat('atol'); if (atol !== null) payload.atol = atol;
            // Control
            const ctrl = params.get('ctrl');
            const kp = readFloat('kp');
            const kd = readFloat('kd');
            const cq0 = readFloat('cq0');
            const cq1 = readFloat('cq1');
            const cq2 = readFloat('cq2');
            const cq3 = readFloat('cq3');
            const qc = [cq0, cq1, cq2, cq3];
            if (ctrl === 'inertial_linear') payload.control_type = 'tracking';
            else if (ctrl === 'inertial_nonlinear') payload.control_type = 'nonlinear_tracking';
            else if (ctrl) payload.control_type = ctrl;
            if (typeof kp === 'number' && !isNaN(kp)) payload.kp = kp;
            if (typeof kd === 'number' && !isNaN(kd)) payload.kd = kd;
            if (qc.every(v => typeof v === 'number' && !isNaN(v))) payload.qc = qc;
            // Epoch for Earth rotation parameters (if provided via config page)
            const epoch = params.get('epoch');
            if (epoch) payload.epoch_utc = epoch;

            animateTo(25);
            // Request precomputation
            try {
                const res = await fetch('/api/compute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                animateTo(60);
                const data = await res.json();
                if (!data || !data.dataset) {
                    throw new Error(data && data.error ? data.error : 'Precompute failed');
                }
                // Store dataset in sessionStorage and move to simulation
                sessionStorage.setItem('precomputed_dataset', JSON.stringify(data.dataset));
                if (data.metrics) {
                    sessionStorage.setItem('precomputed_metrics', JSON.stringify(data.metrics));
                }
                animateTo(100);
                window.location.replace('/simulation?' + params.toString());
            } catch (e) {
                console.error(e);
                animateTo(100);
                // Fallback: still navigate; the sim page will compute via websocket
                window.location.replace('/simulation?' + params.toString());
            }
        })();
    </script>
</body>
</html>


